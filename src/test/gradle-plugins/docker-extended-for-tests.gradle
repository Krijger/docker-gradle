apply plugin: 'groovy'
apply plugin: 'docker'

repositories {
  jcenter()
}

def travisBuild = System.getenv('TRAVIS_BRANCH') != null
logger.info "Running on Travis: '$travisBuild'"

docker {
  stopContainers = !travisBuild
}

task('cleanup', description: 'Remove the test docker image by id, even when it is tagged', type: Exec) {
  commandLine 'docker', 'rmi', "${-> project.docker.imageId}"
}.onlyIf { extensions.docker.stopContainers }

tasks.cleanup.mustRunAfter tasks.test
tasks.matching({ task -> task.group == 'Docker' }).each { dockerTask ->
  tasks.cleanup.mustRunAfter dockerTask
}
tasks.check.dependsOn tasks.cleanup
